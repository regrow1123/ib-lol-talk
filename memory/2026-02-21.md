# 2026-02-21 Session Notes

## ib-lol-talk 게임 개발 (Discord #ib-lol-talk)

### 오늘 작업 요약
대량의 기능 추가, 버그 수정, 아키텍처 변경이 있었음.

### UI 변경
- 셋업 화면 스펠/룬 아이콘 → DDragon CDN 실제 게임 이미지 (40px)
- 상태창에 선택한 룬 아이콘+이름 표시 (플레이어+적 모두)
- 상단 턴 표시 제거
- 위치 태그 한국어화 (MELEE_RANGE→근접, MID_RANGE→중거리 등)
- 스킬레벨업: 오버레이 제거 → suggestions 영역에서 선택하도록 변경
- 게임 종료 복기 시 선택지 영역에 새 게임 시작 버튼
- suggestions 이모지 사용 금지

### 프롬프트 개선
- Q2 미니언 관통 명시 (표식 대상 무조건 적중)
- suggestions 체계적 가이드 (상황별 카테고리, 읽기/교육 필수)
- AI 말투: "~함 체" → 구체적 종결어미(~했음/~됐음/~인듯/~ㅋㅋ)로 변경. "체" 글자 사용 금지 명시

### 비용 최적화
- Prompt caching (static/dynamic 분리, cache_control)
- diff 응답 (변경 필드만 리턴)
- History 압축 (최근 2턴 원문, 이전은 1줄 요약)
- max_tokens 1024→800
- History 10→6 (이후 압축으로 대체)
- 인증/잔액 에러(401/402/403) 재시도 안 함
- JSON 파싱: 중괄호 매칭 + 재시도 2회

### 아키텍처 변천
1. **V2** (LLM 중심) — 원래 설계
2. **V3** (규칙 엔진 + LLM 서술) — 시도했으나 "LLM이랑 대화하는 느낌"이 사라짐
   - 의도 기반 전투 시스템까지 설계 (intent-matrix, AI 성격 3종)
   - 결론: 사용자가 원하는 건 RP에 가까운 경험
3. **V2.1** (V2 복원 + 비용 최적화 + AI 성격 프롬프트)
4. **V2.2** (현재) — 레벨업을 서버 관리로 이관
   - LLM에서 levelUp 필드 제거
   - 서버가 CS 기반 csToLevel()로 100% 판정
   - suggestions가 레벨업 턴에도 항상 유지됨

### 핵심 결정
- **V3 규칙 엔진은 과도했음** — 사용자가 원하는 건 "LLM이랑 라인전 RP" 느낌
- **모델 분기(Haiku/Sonnet) 안 함** — 톤 불일치, 저강도 판단 어려움, 품질 우선
- **확률 요소 싫어함** — 의도 조합이 100% 결정적이어야 심리전
- **AI에게 읽을 수 있는 패턴** 필요 — 성격(호전적/계산적/반응형)으로 구현
- V3 파일은 삭제 안 하고 남겨둠

### 잔액 이슈
- "잠깐 정신이 팔렸음" fallback 메시지가 계속 나옴 → 원인: Anthropic API 잔액 부족
- prefill 방식도 시도했으나 실패 → 잔액 문제였음

### 현재 파일 구조 (V2.2)
- Frontend: src/index.html, src/css/style.css, src/js/main.js
- Server: server/game.js, server/llm.js, server/prompt.js, server/validate.js, server/champions.js
- V3 잔여: server/intent.js, server/combat.js, server/ai.js, server/narrator.js, server/suggest.js
- API: api/start.js, api/turn.js, api/skillup.js
- Data: data/champions/lee-sin.json, data/rules/*.json
- GitHub: regrow1123/ib-lol-talk, Vercel 배포

### V2.2 이후 — 클라이언트 사이드 엔진 시도 (저녁)
- 사용자가 다시 하이브리드 아키텍처 재시도: 이번엔 클라이언트 측 모듈로
- 새 파일 생성: `src/js/engine.js`, `src/js/champion.js`, `src/js/templates.js`, `src/js/minions.js`
- `docs/COMBINATION_TABLE.md` — 액션 조합 규칙 테이블 정의
- `docs/GAME_DESIGN.md`, `docs/LEE_SIN_DATA.md` 업데이트
- main.js, style.css, index.html 대폭 수정
- 아직 통합/테스트 진행 중 — 작동 여부 미확인

### 최신 커밋
`1845a80` — V2.2 레벨업 서버 관리 (클라이언트 모듈은 아직 미커밋)
